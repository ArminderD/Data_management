---
title: "Analysis of Public Health Data"
subtitle: 'Introduction to R and Data Management'
author: ""
date: ""
output: html_document

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

***
### Learning objectives

This module provides an introduction to the R statistical package. On completion of this module you should:


1. Have an understanding of basic features of the R statistical program 
2. Be familiar with the R environment 
3. Be able to undertake basic R commands to input, view, describe and save data 
4. Be able to generate basic graphs 
5. Have an understanding of the requirements for data checking and data cleaning 
6. Be able to undertake manipulation of variables, including dates 
7. Be able to undertake manipulation of datasets, such as appending, merging and reshaping

***

#### Textbook 
+	Kirkwood B and Sterne J. Essential Medical Statistics, 2nd Edition. May 2003, ©2003, Wiley-Blackwell. 

#### References 
+	Donegan K, King B and Bryan P. Safety of pertussis vaccination in pregnant women in UK: observational study. BMJ 2014;349:g4219 doi: 10.1136/bmj.g4219 (Published 11 July 2014). 

+	Gregoire AJ, Kumar R, Everitt B, Henderson AF, Studd JW. Transdermal oestrogen for treatment of severe postnatal depression. Lancet. 1996 Apr 6;347(9006):930-3. 

+ Rabe-Hesketh S and Everitt B. A Handbook of Statistical Analyses Using R; Fourth Edition. 2007, Chapman & Hall/CRC. 

+ Spanos A, Harrell FE, Durack DT. Differential diagnosis of acute meningitis: An analysis of the predictive value of initial observations. JAMA, 1989; 262: 2700-2707. 

#### Datasets 

##### *Meningitis data* 
+ meningitis.csv dataset: dataset in csv (comma delimited) format 

##### *Pertussis data*
+ pertussis.csv 

##### *Dates data*
+ date exercise.csv: date exercise in csv (comma delimited) format 

##### *Postnatal depression data* 
+	depress1a.csv
+ depress1b.csv 
+ depress2.csv 
+ depress3b.csv 
+ depress4_5.csv 
+ depress6a.csv 
+ depress6b.csv 



### Introduction to R and Describing Data

R is a very powerful, and relatively easy to use Statistical package which allows you to undertake data management and manipulation, perform a range of basic and complex statistical tests and analyses, and generate a wide variety of different graphs. For this course, you will be required to use R to undertake basic analysis and graphics.

R is a dialect of the S language. It is a case-sensitive, interpreted language. You can enter commands one at a time at the command prompt (>) or run a set of commands from a source file. There is a wide variety of data types, including vectors (numerical, character, logical), matrices, data frames, and lists. Most functionality is provided through built-in and user-created functions and all data objects are kept in memory during an interactive session. Basic functions are available by default. Other functions are contained in packages that can be attached to a current session as needed.

R packages are bundles of functions which extend the capabilities of R. Thousands of add-on packages are available in the main online repository (CRAN) and several more packages can be found on GitHub. These packages can be found and installed online. 

Stata and R have minor difference in default setting and methods. In this document, we will follow the Stata analysis as closely as possible, but small and usually important difference in Stata and R will be noted. Unlike Stata, R can hold multiple datasets in memory simultaneously and so, there is no need to save intermediate files or close and re-open datasets. 

You need to communicate with R in a way that the program understands; i.e. you need to be able to tell R what you want in a way that it understands. You can do this by typing in commands using an appropriate “language”.

Syntax, also sometimes referred to as “code” or “programming”, refers to the grammatical rules that you need to follow so that R understands what you want it to do. Syntax does not necessarily follow rules of English grammar! You tell R to do something by using the correct command or set of commands. An R command is a combination of syntax elements, expressed following the rules of ‘R language’. 


### R Studio

R Studio is an integrated development environment (IDE) for R. It includes a console, syntax-highlighting editor that supports direct code execution, as well as tools for plotting, history, and debugging and workspace management.  It is available in open source and commercial editions on the desktop (Windows, Mac, and Linux) and from a web browser to a Linux server running R Studio Server or R Studio Server Pro. In this course, we will be using R Studio. The R Studio environment is similar to the Stata environment and we hope will help ease the transition from Stata to R. 

Ensure you have the latest [Java](https://www.java.com/en/download/) installed. Download and install [R](https://cran.r-project.org/) and [RStudio](https://www.rstudio.com/products/rstudio/download/)

### The R Program 

Open the R program using RStudio by double-clicking on the icon (as you would open any other program that you are familiar with).

```{r, fig.align='center', out.width = "100px", echo=FALSE}
knitr::include_graphics("fig1_Ricon.png")
```

### RStudio Interface

The diagram below shows the open RStudio program; you will see that there are various different components or windows. The R windows are: 

+ R Script– where you type in R commands one by one (visible once you open or create a new R scropt file) 

+ Console window – this shows a log of everything you do in R session, including commands and results of these commands 

+ History – keeps a record of every command you enter in R session 

+	Environment–stored all the datasets, arrays, lists and variables created in R

+	Figures – Displays all plots and figures created in R. You can use the arrows to move between images. The export option can be used to save the plots as pdf or image, or to copy plots to clipboard. 

+ Packages – you can select the packages to be installed from the list of packages 

```{r, fig.align='center', out.width = "750px", echo=FALSE}
knitr::include_graphics("fig2_Rstudio_screenshot.png")
```

### RStudio Menu 

On the top left hand side of the screen you will see the set of R icons.


```{r, fig.align='center', out.width = "750px", echo=FALSE}
knitr::include_graphics("fig3_Rstudio_screenshot_2nd.png")
```


    On your computer, identify: 
    1. the R console
    2. the R script
    3. the R environment
    

### Datasets

The first dataset we will be using has been modified from a dataset for 581 patients with acute meningitis (Table 1). Data from a subset of 422 patients were used to examine factors associated with differentiating between acute viral or acute bacterial meningitis^[Spanos A, Harrell FE, Durack DT. Differential diagnosis of acute meningitis: An analysis of the predictive value of initial observations. JAMA, 1989; 262: 2700-2707]. The original dataset can be found at: http://biostat.mc.vanderbilt.edu/wiki/pub/Main/DataSets/Cabm.html

The dataset is available as **meningitis.csv** dataset: A comma delimited Excel file which can be imported into R or other statistical programs; this type of file has a .csv extension. 


**Table1:**  Format of meningitis dataset

```{r, fig.align='center', out.width = "750px", echo=FALSE}
knitr::include_graphics("table1_formatting.png")
```


## Opening data 

### Creating a new project

Create a new R project under “File > New Project…” and select “New Directory > New Project” (noting file path so that you know where to save .csv files etc. on your computer). 

The project file name you just created will end in .Rproj. Locate the folder containing this file. This will be your working directory.  This method is recommended each time you are working on a new project. 

Save all .csv files to the folder containing your .Rproj file (you may need to convert some data files to .csv files). 

### Reading your datasets. 
 
To import data from a .csv file:
This can be done by saving your excel or R file as a .csv file and importing in directly into R 


```{r}
meningitis <- read.csv("meningitis.csv")
```


*Menu driven method:*

You can import data in another format, using the File Menu. These include, csv, excel, SPSS, SAS and Stata files. Click on the File > Import Dataset, and specify the type of file you want to open – for .csv file, specify “From Text (readr)”.

Use the “browse” icon to specify the directory and dataset to be opened.


You can preview the first 50 observation in the dataset and the corresponding code to open the dataset. 

```{r, fig.align='center', out.width = "750px", echo=FALSE}
knitr::include_graphics("fig5_screenshot_4th.png")
```
*Note: the code displayed varies from the one mentioned above. This is an example of the flexibility R provides the user with. There are multiple ways to do the same thing in R.*

The file has the variable names in the first row – you therefore you need to click on this box. 

When you specify the required dataset, R will show you part of the dataset, as shown above. You can see that the first row of the file includes the names of the variables (this will generally be the case for most datasets that you will be working with), and you need to check the box First row as variable names.

    Open the dataset using the read.csv command or File Import Menu. You can play around with opening the different 
    types of datasets. 
    
    What do you see in each of the windows when you open the dataset?

### Browsing your data

R Studio has a nice feature where everything is in one browser window, so you can browse your dataset and your code without having to switch between windows. 

```{r,eval=FALSE }
#to view your dataset 
View(meningitis)
``` 

Alternatively, you can also view your dataset by clicking on “meningitis” in on the top right panel in R studio browser (in the "Environment" panel), as shown below:


```{r, fig.align='center', out.width = "750px", echo=FALSE}
knitr::include_graphics("fig6_screenshot_5th.png")
```

      How many variables are there? How many observations? 
      What do you think that the NA values mean? (More on this later!)

### R help function 

The `help()` function and `?` help operator in R provide access to the documentation pages for R functions, data sets, and other objects, both for packages in the standard R distribution and for contributed packages. 
Example: To access documentation for the standard *lm* (linear model) function, for example, enter the command `help(lm)` or `help("lm")`, or `?lm` in R console. Another way is shown below:

```{r, fig.align='center', out.width = "750px", echo=FALSE}
knitr::include_graphics("fig7_screenshot_6th.png")
```


### R Commands vs Menu


So far we have used the menus to do what we want in R as well as typing the command directly into the console and then pressing the enter key (note that no commands will be read by R until you have hit enter). You may have noticed that when you use the menus, the commands actually appear in the console. This is very helpful as you can clearly see what commands you have undertaken, and can also enable you to copy and save commands into a file which you can later review or run again. Unlike Stata, R is more command driven than menu driven and the menu-driven methods allow for limited functions in R. 

Almost everything in R is done through functions. A function is a piece of code written to carry out a specified task; it may accept arguments or parameters (or not) and it may return one or more values (or not!). The core of R is an interpreted computer language which allows branching and looping as well as modular programming using functions. R allows integration with the procedures written in the C, C++, .Net, Python or FORTRAN languages for efficiency.


**Table 2:** Some commonly used R commands

```{r, fig.align='center', out.width = "750px", echo=FALSE}
knitr::include_graphics("table2_r_commands.png")
```

### The summary command

    1. Type the word summary(dataset) in the console and press enter. 
    What has happened? How many variables are there? How many observations?

    2. Type summary(sex) into the command bar. 
    How is this result different to the one above?
    

### Variable Types 

Variables in R can contain numbers or strings (characters which can be letters or numbers, or sometimes other special characters). String variables can be up to 244 characters long. Numeric variables are stored either as integers (bytes, integers or longs) or floating point (float or double). The variable type is listed under the second column in the `str()` command output. You can check the length of the character variables using the `nchar()` command. 
 
It is important to be familiar with different types of variables and the way they are stored in R. Some analyses require that data be stored as numeric rather than string variables. This means for example that sex is better stored as numbers (e.g. 0 or 1) rather than string variables (ie “female” or “male”). 

While storing variable values as numbers is important for analysis, we need to be know what each of these values represent; for example if we code sex as 0 or 1, which value represents males and which females? We need to have a data dictionary, which “translates” the numeric values in to character labels. You can label the numeric values of a variable in R so that the words rather than the numeric values are displayed; the numeric values will be retained for analysis purposes. We will discuss this later.

    Type dataset_name in the console and press enter. What does this show? 
    Type dataset_name$var1 then press enter. What does this show?

